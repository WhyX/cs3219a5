<!DOCTYPE html>
<html lang="en">
  <head>
    <title>{{seo.effort.title}}</title>
    <meta charset="utf-8">
    <meta name="description" content="{{seo.downloads.description}}">
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="assets/js/html5shiv.js"></script>
    <![endif]-->
    <style>
      .arc text {
        font: 15px sans-serif;
        text-anchor: middle;
      }

      .arc path {
        stroke: #fff;
      }

      .header {
        padding-left: 20px;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
  </head>

  <body class="{{seo.downloads.body_class}}">

    <div class="container">

      {{> head }}

      <div class="placeholder">
        {{> effort }}
      </div>

      <script>
      var url = "https://api.github.com/repos/tungnk1993/scrapy/stats/contributors";
      var targetContributors = {"pablohoffman": "pablohoffman", "dangra": "dangra", "curita": "curita"};
      $.get(url, function(data, status) {
        console.log(data);
        var processedData = preProcess(data);

        createPieChart(processedData);
      });

      var preProcess = function(data) {
        console.log(data);
        var processedData = [];

        for (var i = 0; i < data.length; i ++) {
          var author = data[i].author.login;
          if(targetContributors[author] == null) {
            continue;
          }
          var contributor = {};

          contributor["name"] = author;
          contributor["commits"] = data[i].total;

          processedData.push(contributor);
        }

        return processedData;
      }

      var createPieChart = function(data) {
        var width = 1500, height = 600, radius = 250;
        // var color = d3.scale.category10();
        var color = d3.scale.ordinal().range(["#A0EEC0","#21A0A0","#41b6c4","#1d91c0","#225ea8","#253494","#081d58", "#0f7788","#edf8b1","#c7e9b4"]);
        var arc = d3.svg.arc().outerRadius(radius).innerRadius(0);
        var textLabelArc = d3.svg.arc().outerRadius(radius).innerRadius(radius);
        var commitLabelArc = d3.svg.arc().outerRadius(radius - 20).innerRadius(radius - 20);
        var pie = d3.layout.pie().sort(null).value(function(d) { return d.commits; });
        var svg = d3.select("body").append("svg").attr("width", width).attr("height", height).append("g")
            .attr("transform", "translate(" + width / 3.2 + "," + height / 2 + ")");

        var g = svg.selectAll(".arc")
              .data(pie(data))
              .enter().append("g")
              .attr("class", "arc");

        g.append("path")
            .attr("d", arc)
            .style("fill", function(d) { return color(d.data.name); });

        g.append("text")
            .attr("transform", function(d) { 
              var temp = textLabelArc.centroid(d);

                if (temp[0] < -40) {
                  temp[0] = temp[0] - 100;
                }
                if (temp[0] > 40) {
                  temp[0] = temp[0] + 87;
                }
                if (temp[0] >= -40 && temp[0] <= 40) {
                  if(temp[1] > 0) {
                    temp[1] += 20;
                  } else {
                    temp[1] -= 20;
                  }
                }

                return "translate(" + temp + ")"; 
            }).text(function(d) { return d.data.name + ", " + d.data.commits + " commits"});
          }
        </script>
  </body>
</html>
